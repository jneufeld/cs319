@model DREAM.Models.RequestViewModel
@using DREAM.Models
@using DREAM.Helpers

@{
    ViewBag.Title = "Edit Request";
}

@if (ViewBag.IsLocked)
{
<div class="row">
    <div class="span12">
        This request is currently locked and cannot be edited.
    </div>
</div>
}

@if (!ViewBag.IsLocked)
{
    <div class="row">
        <div class="span12">
            <h2>Edit Request</h2>

            <div class="btn-group">
                <a href="javascript:void(0);" onclick="viewModel.closeRequest();" class="btn">Close Request</a>
                @Html.ActionLink("Export", "Export", new { reqId = Model.RequestID }, new { @class = "btn" })
                @Html.ActionLink("Audit Request", "Index", "LogsAdmin",
                    new { request = Model.RequestID }, new { @class = "btn" })
            </div>
            
            <hr />
            </div>
        </div>

        using (Html.BeginForm())
        {

        @Html.AntiForgeryToken()

        <fieldset>

            <div class="row">
                <div class="span6">
                    <div class="control-group">
                        @Html.LabelFor(model => model.RequestID)
                        <div class="controls">
                            @Html.HiddenFor(m => m.RequestID)
                            @Html.DisplayTextFor(model => model.RequestID)
                        </div>
                    </div>

                    <div class="control-group">
                        @Html.LabelFor(model => model.RequesterTypeStringID)
                        <div class="controls">
                            @Html.DropDownListFor(m => m.RequesterTypeStringID, (IEnumerable<SelectListItem>)ViewData["RequesterTypeList"])
                        </div>
                    </div>

                    <div class="control-group">
                        @Html.LabelFor(model => model.Status)
                        <div class="controls">
                            @Html.TextBoxFor(model => model.Status, new { disabled = "disabled", @readonly = "readonly" })
                            @Html.HiddenFor(model => model.Close)
                        </div>
                    </div>
                </div>

                <div class="span6">
                    <div class="control-group">
                        @Html.LabelFor(model => model.CreationTime)
                        <div class="controls">
                            @Html.HiddenFor(m => m.CreationTime)
                            @Html.DisplayTextFor(model => model.CreationTime)
                        </div>
                    </div>
                
                    <div class="control-group">
                        @Html.LabelFor(model => model.CreatedBy)
                        <div class="controls">
                            @Html.HiddenFor(m => m.CreatedBy)
                            @Html.DisplayTextFor(model => model.CreatedBy)
                        </div>
                    </div>
                
                    <div class="control-group">
                        @Html.LabelFor(model => model.CompletionTime)
                        <div class="controls">
                            @Html.HiddenFor(m => m.CompletionTime)
                            @Html.DisplayTextFor(model => model.CompletionTime)
                        </div>
                    </div>
                
                    <div class="control-group">
                        @Html.LabelFor(model => model.ClosedBy)
                        <div class="controls">
                            @Html.HiddenFor(m => m.ClosedBy)
                            @Html.DisplayTextFor(model => model.ClosedBy)
                        </div>
                    </div>
                </div>
            </div>

            <hr />

            <div class="row">
                <div class="span6">
                    <h4>Caller Data</h4>
                    @Html.HiddenFor(m => m.CallerID)

                    <div class="control-group">
                        @Html.LabelFor(m => m.CallerFirstName)
                        <div class="controls">
                            @Html.TextBoxFor(m => m.CallerFirstName, new { id = "caller-first" })
                            <div class="span5">
                                @Html.ValidationMessageFor(m => m.CallerFirstName)
                            </div>
                        </div>
                    </div>

                    <br />

                    <div class="control-group">
                        @Html.LabelFor(m => m.CallerLastName)
                        <div class="controls">
                            @Html.TextBoxFor(m => m.CallerLastName, new { id = "caller-last" })
                            <div class="span5">
                                @Html.ValidationMessageFor(m => m.CallerLastName)
                            </div>
                        </div>
                    </div>

                    <br />

                    <div class="control-group">
                        @Html.LabelFor(m => m.CallerEmail)
                        <div class="controls">
                            @Html.EditorFor(m => m.CallerEmail)
                            <div class="span5">
                                @Html.ValidationMessageFor(m => m.CallerEmail)
                            </div>
                        </div>
                    </div>

                    <br />

                    <div class="control-group">
                        @Html.LabelFor(m => m.CallerPhoneNumber)
                        <div class="controls">
                            @Html.EditorFor(m => m.CallerPhoneNumber)
                            <div class="span5">
                               @Html.ValidationMessageFor(m => m.CallerPhoneNumber)
                            </div>
                        </div>
                    </div>

                    <br />

                    <div class="control-group">
                        @Html.LabelFor(m => m.CallerRegionStringID)
                        <div class="controls">
                            @Html.DropDownListFor(m => m.CallerRegionStringID, (IEnumerable<SelectListItem>)ViewData["RegionList"])
                            <div class="span5">
                                @Html.ValidationMessageFor(m => m.CallerRegionStringID)
                            </div>
                        </div>
                    </div>
                </div>

                <div class="span6">
                    <h4>Patient</h4>
                    @Html.HiddenFor(m => m.PatientID)

                    <div class="control-group">
                        @Html.LabelFor(m => m.PatientFirstName)
                        <div class="controls">
                            @Html.TextBoxFor(m => m.PatientFirstName, new { id = "patient-first" })
                            <div class="span5">
                                @Html.ValidationMessageFor(m => m.PatientFirstName)
                            </div>
                        </div>
                    </div>

                    <br />

                    <div class="control-group">
                        @Html.LabelFor(m => m.PatientLastName)
                        <div class="controls">
                            @Html.TextBoxFor(m => m.PatientLastName, new { id = "patient-last" })
                            <div class="span5">
                                @Html.ValidationMessageFor(m => m.PatientLastName)
                            </div>
                        </div>
                    </div>

                    <br />

                    <div class="control-group">
                        @Html.LabelFor(m => m.PatientAgencyID)
                        <div class="controls">
                            @Html.EditorFor(m => m.PatientAgencyID)
                            <div class="span5">
                                @Html.ValidationMessageFor(m => m.PatientAgencyID)
                            </div>
                        </div>
                    </div>

                    <br />

                    <div class="control-group">
                        @Html.LabelFor(m => m.PatientGender)
                        <div class="controls">
                            @Html.DropDownListFor(m => m.PatientGender, (IEnumerable<SelectListItem>)ViewData["GenderList"])
                            <div class="span5">
                                @Html.ValidationMessageFor(m => m.PatientGender)
                            </div>
                        </div>
                    </div>

                    <br />

                    <div class="control-group">
                        @Html.LabelFor(m => m.PatientAge)
                        <div class="controls">
                            @Html.EditorFor(m => m.PatientAge)
                            <div class="span5">
                                @Html.ValidationMessageFor(m => m.PatientAge)
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <hr />

            <h3>Questions</h3>
                            
            @if (Model.Questions == null || Model.Questions.Count == 0)
            {
                <p>None.</p>
            }

            <ul id="questionList" style="list-style-type: none">
                @if (Model.Questions != null)
                {
                    foreach (QuestionViewModel qv in Model.Questions)
                    {
                        Html.RenderPartial("QuestionEntry", qv);
                    }
                }
            </ul>

            @Html.HiddenFor(m => m.QuestionCount)

            @Html.ValidationSummary(true)

            <hr />

            <div class="row">
                <div class="span12">
                    <a href="javascript:void(0);" onclick="viewModel.addNewQuestion();" class="btn btn-large btn-success span3">Add new question</a>
                    <button type="submit" class="btn btn-large btn-primary span3">Submit Changes</button>
                </div>
            </div>

                </fieldset>
    }
}


@section Scripts {
    @Scripts.Render("~/bundles/jquery")
    @Scripts.Render("~/bundles/jqueryval")
    <script src="@Url.Content("~/Scripts/jQuery.tmpl.min.js")" type="text/javascript"></script>
    @Scripts.Render("~/bundles/jqueryui")
    @Scripts.Render("~/bundles/jquerytmpl")
    @Styles.Render("~/Content/themes/base/css")
    <script type="text/javascript"> if (!window.console) console = { log: function () { } }; </script>

    <script type="text/x-jquery-tmpl" id="questionTemplate">
        @(Html.CollectionItemJQueryTemplate<RequestViewModel, QuestionViewModel>("QuestionEntry", new QuestionViewModel { Index = "${QIndex}" }))
    </script>
    <script type="text/x-jquery-tmpl" id="keywordTemplate">
        @(Html.CollectionItemJQueryTemplate<RequestViewModel, KeywordViewModel>("KeywordEntry", new KeywordViewModel { }))
    </script>
    <script type="text/x-jquery-tmpl" id="referenceTemplate">
        @(Html.CollectionItemJQueryTemplate<RequestViewModel, ReferenceViewModel>("ReferenceEntry", new ReferenceViewModel { }))
    </script>

    <script type="text/javascript">
        var viewModel = {
            addNewQuestion: function () {
                var count = $("input[name=QuestionCount]:hidden");
                var idx = count.val();
                var $obj = $("#questionTemplate").tmpl({ Questions_index: viewModel._generateGuid(), Keywords_index: viewModel._generateGuid(), References_index: viewModel._generateGuid(), QIndex: idx });
                viewModel.addImpactUpdateHandler($obj);
                $("#questionList").append($obj);
                var next = +idx + 1;
                count.val(next);
            },

            addNewKeyword: function ($keywordsList, prefix) {
                var $obj = $("#keywordTemplate").tmpl({ prefix: prefix, Keywords_index: viewModel._generateGuid() });
                viewModel.applyKeywordAutocomplete($obj.find(".keywordAutocomplete"));
                viewModel.addDeleteHandler($obj.find(".deleteKeyword"));
                $keywordsList.append($obj);
            },

            addNewReference: function ($referenceList, prefix) {
                var $obj = $("#referenceTemplate").tmpl({ prefix: prefix, References_index: viewModel._generateGuid() });
                viewModel.addDeleteHandler($obj.find(".deleteReference"));
                $referenceList.append($obj);
            },

            _generateGuid: function () {
                // Source: http://stackoverflow.com/questions/105034/how-to-create-a-guid-uuid-in-javascript/105074#105074
                return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function (c) {
                    var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
                    return v.toString(16);
                });
            },

            applyKeywordAutocomplete: function (node) {
                $(node).autocomplete({
                    source: function (request, response) {
                        $.ajax({
                            url: "/Autocomplete/Keyword", type: "POST", dataType: "json",
                            contentType: "application/json; charset=utf-8",
                            data: "{ \"prefix\": \"" + request.term + "\" }",
                            async: true,
                            success: function (data) {
                                response(data);
                            },
                            error: function (result) {
                                response(null);
                            }
                        });
                    },
                    delay: 500,
                    minLength: 2,
                    select: function (event, ui) {
                        $(node).find("input[name$=Keyword]").val(ui.item.value);
                    },
                });
            },

            addDeleteHandler: function (node) {
                $(node).click(function () {
                    var par = $(this).closest("li");
                    var deleted = par.find("input[name$=Delete]:hidden");
                    console.log(par);
                    console.log(deleted);
                    deleted.val('True');
                    par.hide(0.5);
                });
            },

            computeImpact: function (severity, probability) {
                var probableLookup = { "Major": 1, "Moderate": 2, "Minor": 3 };
                var possibleLookup = { "Major": 4, "Moderate": 4, "Minor": 5 };
                var unlikelyLookup = { "Major": 5, "Moderate": 5, "Minor": 5 };
                var problookup = {};
                problookup["Probable"] = probableLookup;
                problookup["Possible"] = possibleLookup;
                problookup["Unlikely"] = unlikelyLookup;
                var l = problookup[probability];
                if (l) {
                    return l[severity];
                }
                else
                    return 0;
            },

            addImpactUpdateHandler: function (questionItem) {
                var handler = function (obj) {
                    var $prob = questionItem.find("select[name$=Probability]");
                    var $severity = questionItem.find("select[name$=Severity]");
                    var prob = $prob.val();
                    var severity = $severity.val();
                    var $impact = questionItem.find("input[name$=Impact]");
                    var impact = viewModel.computeImpact(severity, prob);
                    console.log(prob);
                    $impact.val(impact);
                }
                var $prob = questionItem.find("select[name$=Probability]");
                var $severity = questionItem.find("select[name$=Severity]");
                $prob.change(handler);
                $prob.trigger('change');
                $severity.change(handler);
            },

            closeRequest: function () {
                $("input[name=Close]:hidden").val('True');
                $("input[name=Status]").val('Closed');
            }

        };

        $("body").on("click", ".addNewKeyword", function () {
            var $keywordList = $(this).siblings(".keywordValues");
            var keywordIndex = $(this).siblings("input[type='hidden']").val();
            var prefix = "Questions[" + keywordIndex + "].";
            viewModel.addNewKeyword($keywordList, prefix);
            return false;
        });

        $("body").on("click", ".addNewReference", function () {
            var $referenceList = $(this).siblings(".referenceValues");
            var referenceIndex = $(this).siblings("input[type='hidden']").val();
            var prefix = "Questions[" + referenceIndex + "].";
            viewModel.addNewReference($referenceList, prefix);
            return false;
        });

        $(function () {
            $("#PatientAgencyID").autocomplete({
                source: function (request, response) {
                    $.ajax({
                        url: "/Autocomplete/Patient", type: "POST", dataType: "json",
                        contentType: "application/json; charset=utf-8",
                        data: "{ \"agencyId\": \"" + request.term + "\" }",
                        async: true,
                        success: function (data) {
                            response($.map(data, function (item) {
                                return item;
                            }))
                        },
                        error: function (result) {
                            response(null);
                        }
                    });
                },
                delay: 500,
                minLength: 2,
                select: function (event, ui) {
                    $("input[name=PatientAgencyID]").val(ui.item.AgencyID);
                    $("input[name=PatientFirstName]").val(ui.item.FirstName);
                    $("input[name=PatientLastName]").val(ui.item.LastName);
                    $("input[name=PatientGender]").val(ui.item.Gender);
                    $("input[name=PatientAge]").val(ui.item.Age);
                },
            });

            $keywordInputs = $(".keywordAutocomplete");
            $.each($keywordInputs, function(i, val) {
                viewModel.applyKeywordAutocomplete(val);
            });

            $keywordDeleters = $(".deleteKeyword");
            $.each($keywordDeleters, function (i, val) {
                viewModel.addDeleteHandler(val);
            });

            $referenceDeleters = $(".deleteReference");
            $.each($referenceDeleters, function (i, val) {
                viewModel.addDeleteHandler(val);
            });

            $questionItems = $(".questionItem");
            $.each($questionItems, function (i, question) {
                var $question = $(question);
                viewModel.addImpactUpdateHandler($question);
                $question.find("input[name$=Probability]").change();
            });
        });
    </script>
}
